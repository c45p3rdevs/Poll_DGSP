<!doctype html>
<html lang="es" data-theme="light" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Estadísticas Votación 2025</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:['class','[data-theme="dark"]']};</script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet"/>

  <!-- Inter + Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <meta name="color-scheme" content="light dark"/>
  <style>
    :root{ --accent:#0c5080; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; }
    .brand-gradient{ background:
      radial-gradient(1200px 600px at 0% 0%, rgba(7,89,133,.12), transparent 60%),
      radial-gradient(1200px 600px at 100% 0%, rgba(22,163,74,.12), transparent 60%); }
    .elev{ box-shadow:0 10px 30px rgba(2,6,23,.10); }

    /* Top loader */
    #topLoader{ position:fixed; top:0; left:0; height:3px; width:0; z-index:2147483647;
      background: linear-gradient(90deg, #1767ff, #00069a); box-shadow:0 0 12px rgba(23,103,255,.35); transform:translateZ(0); }
    #topLoader::after{ content:""; position:absolute; inset:0;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.6), transparent);
      background-size:200% 100%; animation:loaderBarShine 1s linear infinite; mix-blend-mode:screen; }
    .loader-fade{ transition:opacity .4s ease; opacity:0; }
    @keyframes loaderBarShine{ to{ background-position:-200% 0; } }

    /* Login overlay netflix-lite azul (local, para proteger la URL de civiles) */
    #adminLogin{ position:fixed; inset:0; z-index:2147483000; display:none; align-items:center; justify-content:center; padding:1.25rem; backdrop-filter:blur(6px); background:rgba(2,6,23,.5); }
    .nf-panel{ width:100%; max-width:420px; border-radius:14px; overflow:hidden;
      background: linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 30px 70px rgba(2,6,23,.40), 0 2px 8px rgba(2,6,23,.25);
      color:#e5eef8;}
    .nf-head{ padding:26px 26px 0 26px; }
    .nf-logo{ width:34px; height:34px; border-radius:10px; background:var(--accent); display:grid; place-items:center; color:#fff; font-weight:800; box-shadow:0 10px 24px color-mix(in oklab, var(--accent) 40%, transparent); }
    .nf-title{ font-size:26px; font-weight:800; color:#fff; margin:10px 0 6px; }
    .nf-sub{ font-size:12.5px; opacity:.8; }
    .nf-body{ padding:18px 26px 24px; }
    .nf-field{ margin-bottom:12px; }
    .nf-label{ display:block; font-size:12px; opacity:.85; margin:0 0 6px 2px; }
    .nf-input{ width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06); color:white; padding:.85rem .9rem; outline:none;
      transition:border-color .15s ease, background .15s ease; }
    .nf-input::placeholder{ color:#c7d2fe88; }
    .nf-input:focus{ border-color: color-mix(in oklab, var(--accent) 65%, white 0%); background:rgba(255,255,255,.10); }
    .nf-btn{ width:100%; border:none; border-radius:10px; margin-top:8px; background:var(--accent); color:#fff; font-weight:800; letter-spacing:.2px; padding:.85rem 1rem; box-shadow:0 16px 28px color-mix(in oklab, var(--accent) 35%, transparent); }
    .spin{ width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; display:inline-block; animation:s .65s linear infinite; vertical-align:-3px }
    @keyframes s{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body class="min-h-full bg-base-200 text-base-content">
  <!-- Top loader -->
  <div id="topLoader" hidden></div>

  <!-- Header -->
  <header class="brand-gradient border-b border-base-300 sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-11 grid place-items-center rounded-2xl bg-primary text-primary-content font-extrabold elev">
          <span class="text-xl">V</span>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold leading-tight">Panel Admin — Estadísticas</h1>
          <p class="text-xs md:text-sm opacity-70">Datos desde <code>data/stats.json</code> (actualizado por GitHub Actions).</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div id="adminBox" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-xl border border-base-300 bg-base-100">
          <span class="material-symbols-rounded text-base opacity-70">shield_person</span>
          <span id="adminName" class="text-sm font-semibold">—</span>
          <button id="btnLogout" class="btn btn-xs">Salir</button>
        </div>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle" title="Tema">
            <span class="material-symbols-rounded">dark_mode</span>
          </div>
          <ul tabindex="0" class="dropdown-content z-[60] menu p-2 shadow bg-base-100 rounded-box w-40">
            <li><a id="themeLight">Claro</a></li>
            <li><a id="themeDark">Oscuro</a></li>
            <li><a id="themeAuto">Auto</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-6">
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Votos Mujeres</div><div id="kpiWomen" class="stat-value">—</div>
        <div id="kpiWomenViews" class="stat-desc">Vistas: —</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Votos Hombres</div><div id="kpiMen" class="stat-value">—</div>
        <div id="kpiMenViews" class="stat-desc">Vistas: —</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Participantes (Mujeres)</div><div id="kpiPartWomen" class="stat-value text-primary">—</div>
        <div class="stat-desc">Poll: 7rnzVbMBanO</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Participantes (Hombres)</div><div id="kpiPartMen" class="stat-value text-secondary">—</div>
        <div class="stat-desc">Poll: e6Z2A3DXXgN</div></div></div>
    </section>

    <!-- Gráficas -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <div class="card bg-base-100 shadow col-span-2"><div class="card-body">
        <h3 class="card-title">Votos por candidata/o</h3>
        <canvas id="barChart" height="100"></canvas>
      </div></div>
      <div class="card bg-base-100 shadow"><div class="card-body">
        <h3 class="card-title">Distribución por género</h3>
        <canvas id="pieChart" height="100"></canvas>
        <div class="text-xs opacity-70 mt-2">Actualizado: <span id="lastUpdate">—</span></div>
      </div></div>
    </section>

    <!-- Tablas -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <div class="card bg-base-100 shadow"><div class="card-body">
        <h3 class="card-title">Ranking — Mujeres</h3>
        <div class="overflow-x-auto"><table class="table table-zebra">
          <thead><tr><th>#</th><th>Candidata</th><th>Votos</th></tr></thead>
          <tbody id="tblWomen"></tbody></table></div>
      </div></div>
      <div class="card bg-base-100 shadow"><div class="card-body">
        <h3 class="card-title">Ranking — Hombres</h3>
        <div class="overflow-x-auto"><table class="table table-zebra">
          <thead><tr><th>#</th><th>Candidato</th><th>Votos</th></tr></thead>
          <tbody id="tblMen"></tbody></table></div>
      </div></div>
    </section>
  </main>

  <!-- Login admin (local) -->
  <section id="adminLogin" aria-hidden="true">
    <div class="nf-panel">
      <div class="nf-head">
        <div class="flex items-center gap-2">
          <div class="nf-logo">A</div>
          <div><div class="text-[12px] opacity-80">Panel</div><div class="text-sm font-semibold">Acceso</div></div>
        </div>
        <div class="nf-title">Inicia sesión</div>
        <div class="nf-sub">Acceso restringido (local).</div>
      </div>
      <form id="loginForm" class="nf-body">
        <div class="nf-field"><label class="nf-label">Usuario</label><input id="inpUser" class="nf-input" placeholder="admin"/></div>
        <div class="nf-field"><label class="nf-label">Contraseña</label><input id="inpPass" type="password" class="nf-input" placeholder="••••••••"/></div>
        <button class="nf-btn" id="btnLogin" type="submit">Entrar</button>
      </form>
      <div class="px-6 pb-6 text-[11.5px] text-[#a9b6cd]">Los datos se leen de <code>data/stats.json</code> generado por Actions.</div>
    </div>
  </section>

  <footer class="max-w-7xl mx-auto px-4 md:px-8 py-8"><div class="text-center text-xs opacity-70">© 2025 — Panel Admin</div></footer>

<script>
/** ========= CONFIG ========= */
const STATS_URL = './data/stats.json'; // generado por Actions
const POLL_ID_MUJER  = "7rnzVbMBanO";
const POLL_ID_HOMBRE = "e6Z2A3DXXgN";

/** ========= THEME + LOADER ========= */
const topLoader=document.getElementById('topLoader'); let raf,prog=0,active=false;
function tick(){ prog+=(95-prog)*.1+.5; topLoader.style.width=prog+'%'; raf=requestAnimationFrame(tick); }
function showTop(){ if(active) return; active=true; topLoader.hidden=false; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; cancelAnimationFrame(raf); tick(); }
function hideTop(){ cancelAnimationFrame(raf); topLoader.style.width='100%'; setTimeout(()=>topLoader.classList.add('loader-fade'),60);
  setTimeout(()=>{ topLoader.hidden=true; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; active=false; },400); }
document.addEventListener('readystatechange',()=>{ if(document.readyState==='interactive') showTop(); if(document.readyState==='complete') hideTop(); });

function setTheme(mode){
  if(mode==='light'){ document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); }
  else if(mode==='dark'){ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
  else{ localStorage.removeItem('theme'); const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark?'dark':'light'); }
}
document.getElementById('themeLight').addEventListener('click',()=>setTheme('light'));
document.getElementById('themeDark').addEventListener('click', ()=>setTheme('dark'));
document.getElementById('themeAuto').addEventListener('click', ()=>setTheme('auto'));
(function(){ const saved=localStorage.getItem('theme'); if(saved==='light'||saved==='dark') setTheme(saved); else setTheme('auto'); })();

/** ========= LOGIN (local) ========= */
const ADMIN_CREDENTIALS = { "admin":"adm1", "ker":"ker1" }; // cambia si quieres
const adminLogin = document.getElementById('adminLogin');
const loginForm  = document.getElementById('loginForm');
const btnLogin   = document.getElementById('btnLogin');
const inpUser    = document.getElementById('inpUser');
const inpPass    = document.getElementById('inpPass');
const adminBox   = document.getElementById('adminBox');
const adminName  = document.getElementById('adminName');

function showAdminLogin(){ adminLogin.style.display='flex'; inpUser.focus(); }
function hideAdminLogin(){ adminLogin.style.display='none'; }
function paintAdmin(u){ adminBox.classList.remove('hidden'); adminName.textContent=u; }

(function initAdminSession(){
  const raw = localStorage.getItem('admin_user');
  if(!raw){ showAdminLogin(); return; }
  try{ const u=JSON.parse(raw); if(u&&u.name){ paintAdmin(u.name); } else showAdminLogin(); }
  catch{ showAdminLogin(); }
})();
loginForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const u=(inpUser.value||'').trim().toLowerCase();
  const p=(inpPass.value||'').trim();
  if(!ADMIN_CREDENTIALS[u] || ADMIN_CREDENTIALS[u]!==p){ alert('Acceso inválido'); return; }
  const prev=btnLogin.innerHTML; btnLogin.disabled=true; btnLogin.innerHTML='<i class="spin"></i> Verificando…';
  setTimeout(()=>{ localStorage.setItem('admin_user', JSON.stringify({name:u})); btnLogin.disabled=false; btnLogin.innerHTML=prev; hideAdminLogin(); startRealtime(); },650);
});
document.getElementById('btnLogout').addEventListener('click', ()=>{
  localStorage.removeItem('admin_user'); location.reload();
});

/** ========= CHARTS ========= */
let barChart, pieChart;
function ensureCharts(){
  if(!barChart){
    barChart=new Chart(document.getElementById('barChart'),{
      type:'bar',
      data:{ labels:[], datasets:[{ label:'Votos', data:[] }]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}}}
    });
  }
  if(!pieChart){
    pieChart=new Chart(document.getElementById('pieChart'),{
      type:'doughnut',
      data:{ labels:['Mujeres','Hombres'], datasets:[{ data:[0,0] }]},
      options:{ responsive:true, maintainAspectRatio:false, cutout:'60%' }
    });
  }
}

/** ========= RENDER ========= */
function normalizePoll(raw){
  const totals = raw?.poll_meta?.vote_count ?? 0;
  const participants = raw?.poll_meta?.participant_count ?? 0;
  const views = raw?.poll_meta?.view_count ?? 0;
  const options = (raw?.poll_options||[]).map(o=>({ name:o.value, votes:o.vote_count||0 }));
  return { totals, participants, views, options, title:raw?.title||'', id:raw?.id||'' };
}
function buildFromCombined(payload){
  const women = normalizePoll(payload?.women || {});
  const men   = normalizePoll(payload?.men   || {});
  return { women, men };
}
function renderTables(arr, tbodyId){
  const tb=document.getElementById(tbodyId); tb.innerHTML='';
  arr.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${r.name}</td><td><b>${r.votes}</b></td>`;
    tb.appendChild(tr);
  });
}
function updateUI(data){
  ensureCharts();
  const { women, men } = buildFromCombined(data);

  document.getElementById('kpiWomen').textContent = women.totals ?? '0';
  document.getElementById('kpiMen').textContent   = men.totals ?? '0';
  document.getElementById('kpiWomenViews').textContent = `Vistas: ${women.views ?? '0'}`;
  document.getElementById('kpiMenViews').textContent   = `Vistas: ${men.views ?? '0'}`;
  document.getElementById('kpiPartWomen').textContent  = women.participants ?? '0';
  document.getElementById('kpiPartMen').textContent    = men.participants ?? '0';
  document.getElementById('lastUpdate').textContent    = new Date().toLocaleString();

  const combined = [
    ...women.options.map(o=>({name:o.name, votes:o.votes})),
    ...men.options.map(o=>({name:o.name, votes:o.votes}))
  ].sort((a,b)=>b.votes-a.votes);

  barChart.data.labels = combined.map(x=>x.name);
  barChart.data.datasets[0].data = combined.map(x=>x.votes);
  barChart.update();

  pieChart.data.datasets[0].data = [women.totals||0, men.totals||0];
  pieChart.update();

  renderTables([...women.options].sort((a,b)=>b.votes-a.votes),'tblWomen');
  renderTables([...men.options].sort((a,b)=>b.votes-a.votes),'tblMen');
}

/** ========= “Realtime” (polling al JSON en Pages) ========= */
let pollTimer=null;
async function fetchOnce(){
  try{
    const r=await fetch(STATS_URL+'?t='+(Date.now()),{cache:'no-store'});
    if(!r.ok) throw 0;
    return await r.json();
  }catch{
    // demo si aún no existe data/stats.json
    return {
      women:{ poll_meta:{vote_count:0,participant_count:0,view_count:0}, poll_options:[] },
      men:{   poll_meta:{vote_count:0,participant_count:0,view_count:0}, poll_options:[] }
    };
  }
}
function startRealtime(){
  const run=()=>fetchOnce().then(updateUI).catch(console.warn);
  run();
  if(pollTimer) clearInterval(pollTimer);
  pollTimer=setInterval(run, 8000);
}

/** ========= INIT ========= */
(function(){
  const saved=localStorage.getItem('admin_user');
  if(saved) startRealtime(); // ya logueado
})();
</script>
</body>
</html>
