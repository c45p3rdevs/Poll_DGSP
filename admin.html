<!doctype html>
<html lang="es" data-theme="light" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Estadísticas Votación 2025</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:['class','[data-theme="dark"]']};</script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet"/>

  <!-- Inter + Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <meta name="color-scheme" content="light dark"/>

  <!-- ======= Estilos propios (panel + toasts) ======= -->
  <style>
    :root{ --accent:#0c5080; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; }
    .brand-gradient{ background:
      radial-gradient(1200px 600px at 0% 0%, rgba(7,89,133,.12), transparent 60%),
      radial-gradient(1200px 600px at 100% 0%, rgba(22,163,74,.12), transparent 60%); }
    .elev{ box-shadow:0 10px 30px rgba(2,6,23,.10); }

    #topLoader{ position:fixed; top:0; left:0; height:3px; width:0; z-index:2147483647;
      background:#0c5080; box-shadow:0 0 8px rgba(12,80,128,.45), 0 0 2px rgba(12,80,128,.9) inset; transition:opacity .35s ease; }
    .loader-fade{ opacity:0; }

    #adminLogin{ position:fixed; inset:0; z-index:2147483000; display:none; align-items:center; justify-content:center; padding:1.25rem; backdrop-filter:blur(6px); background:rgba(2,6,23,.5); }
    .nf-panel{ width:100%; max-width:420px; border-radius:14px; overflow:hidden;
      background: linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 30px 70px rgba(2,6,23,.40), 0 2px 8px rgba(2,6,23,.25);
      color:#e5eef8;}
    .nf-head{ padding:26px 26px 0 26px; }
    .nf-logo{ width:34px; height:34px; border-radius:10px; background:var(--accent); display:grid; place-items:center; color:#fff; font-weight:800; box-shadow:0 10px 24px color-mix(in oklab, var(--accent) 40%, transparent); }
    .nf-title{ font-size:26px; font-weight:800; color:#fff; margin:10px 0 6px; }
    .nf-sub{ font-size:12.5px; opacity:.8; }
    .nf-body{ padding:18px 26px 24px; }
    .nf-field{ margin-bottom:12px; }
    .nf-label{ display:block; font-size:12px; opacity:.85; margin:0 0 6px 2px; }
    .nf-input{ width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06); color:white; padding:.85rem .9rem; outline:none; transition:border-color .15s ease, background .15s ease; }
    .nf-input::placeholder{ color:#c7d2fe88; }
    .nf-input:focus{ border-color: color-mix(in oklab, var(--accent) 65%, white 0%); background:rgba(255,255,255,.10); }
    .nf-btn{ width:100%; border:none; border-radius:10px; margin-top:8px; background:var(--accent); color:#fff; font-weight:800; letter-spacing:.2px; padding:.85rem 1rem; box-shadow:0 16px 28px color-mix(in oklab, var(--accent) 35%, transparent); }
    .spin{ width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; display:inline-block; animation:s .65s linear infinite; vertical-align:-3px }
    @keyframes s{ to{ transform:rotate(360deg);} }

    .chart-wrap{ height:18rem; }
    .chart-wrap-sm{ height:16rem; }

    .person-card{ display:flex; align-items:center; gap:.9rem; padding:.75rem; border:1px solid rgba(2,6,23,.08);
      background:var(--fallback-b1,oklch(var(--b1))); border-radius:14px; }
    .person-img{ width:52px; height:52px; border-radius:12px; object-fit:cover; background:#eef2f7; box-shadow:0 6px 16px rgba(2,6,23,.10); }
    .person-meta{ line-height:1.15; }
    .person-name{ font-weight:700; font-size:.95rem; }
    .person-sub{ font-size:.76rem; opacity:.75; }
    .person-badge{ font-size:.75rem; border-radius:999px; padding:.2rem .5rem; border:1px solid rgba(2,6,23,.12); }

    /* ===== Toasts ===== */
    :root{
      --toast-z:2147483601; --toast-bg:rgba(255,255,255,.86); --toast-fg:#0b1220;
      --toast-border:rgba(2,6,23,.10);
      --toast-shadow:0 20px 40px rgba(2,6,23,.15),0 2px 8px rgba(2,6,23,.08);
      --toast-success:#16a34a; --toast-info:#0ea5e9; --toast-warn:#f59e0b; --toast-error:#ef4444;
    }
    [data-theme="dark"]{
      --toast-bg:rgba(17,24,39,.82); --toast-fg:#eaf2ff; --toast-border:rgba(255,255,255,.14);
      --toast-shadow:0 24px 64px rgba(0,0,0,.45),0 2px 10px rgba(0,0,0,.30);
    }
    #toastHost{position:fixed;right:16px;top:16px;z-index:var(--toast-z);display:grid;gap:10px;width:min(92vw,360px)}
    .ui-toast{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;background:var(--toast-bg);color:var(--toast-fg);
      border:1px solid var(--toast-border);border-radius:14px;padding:12px 12px;backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);box-shadow:var(--toast-shadow);overflow:hidden;transform:translateY(-8px);opacity:0}
    .ui-toast .t-icon{width:28px;height:28px;border-radius:10px;display:grid;place-items:center;color:#fff}
    .ui-toast .t-title{font-weight:800;font-size:14px;line-height:1.1}
    .ui-toast .t-msg{font-size:12.5px;opacity:.9;margin-top:2px;word-wrap:break-word}
    .ui-toast .t-close{border:0;background:transparent;color:inherit;opacity:.7;cursor:pointer}
    .ui-toast .t-close:hover{opacity:1}
    .ui-toast .t-action{margin-left:6px;border:0;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .ui-toast .t-bar{grid-column:1/-1;height:3px;margin-top:8px;background:linear-gradient(90deg,rgba(255,255,255,.15),transparent);position:relative}
    .ui-toast .t-bar>i{position:absolute;inset:0;transform-origin:left}
    .ui-toast.success .t-icon,.ui-toast.success .t-action{background:var(--toast-success)}
    .ui-toast.info    .t-icon,.ui-toast.info    .t-action{background:var(--toast-info)}
    .ui-toast.warn    .t-icon,.ui-toast.warn    .t-action{background:var(--toast-warn)}
    .ui-toast.error   .t-icon,.ui-toast.error   .t-action{background:var(--toast-error)}
    .ui-toast.enter{animation:toastIn .28s ease forwards}
    .ui-toast.exit{animation:toastOut .22s ease forwards}
    @keyframes toastIn{to{transform:none;opacity:1}}
    @keyframes toastOut{to{transform:translateY(-8px);opacity:0}}


/* ====== FIX PACK MÓVIL — ADMIN ====== */

/* micro-ajustes generales */
@media (max-width: 768px){
  .elev{ box-shadow:0 8px 22px rgba(2,6,23,.10); }
  header .max-w-7xl{ padding-left:12px; padding-right:12px; }
  header img.h-11{ height:40px; width:40px; border-radius:.6rem; }
  header h1{ font-size:clamp(1rem, 3.5vw, 1.25rem); }
  header p{ font-size:11.5px; }
}

/* KPIs: tarjetas más compactas */
@media (max-width: 640px){
  .stats{ border-radius:14px; }
  .stats .stat{ padding:14px 14px; }
  .stats .stat-title{ font-size:12px; }
  .stats .stat-value{ font-size:20px; line-height:1.1; }
  .stats .stat-desc{ font-size:11px; }
}

/* charts: altura adecuada en móvil */
@media (max-width: 640px){
  .chart-wrap{ height:260px; }
  .chart-wrap-sm{ height:230px; }
}

/* cartas y layouts */
@media (max-width: 640px){
  .card .card-body{ padding:14px; }
  .card-title{ font-size:1rem; }
}

/* mosaico de personas: 2 columnas en móvil, gap amigable */
@media (max-width: 640px){
  #peopleGrid{
    grid-template-columns: repeat(2, minmax(0,1fr)) !important;
    gap:.6rem !important;
  }
  .person-card{ padding:.6rem; border-radius:12px; }
  .person-img{ width:46px; height:46px; border-radius:10px; }
  .person-name{ font-size:.9rem; }
  .person-sub{ font-size:.72rem; }
  .person-badge{ font-size:.7rem; }
}
@media (max-width: 400px){
  #peopleGrid{ grid-template-columns: 1fr 1fr !important; }
}

/* tablas: que no se salgan */
@media (max-width: 640px){
  .overflow-x-auto{ -webkit-overflow-scrolling: touch; }
  table.table td, table.table th{ padding:.6rem .5rem; }
}

/* footer compacto */
@media (max-width: 640px){
  footer .py-8{ padding-top:18px !important; padding-bottom:18px !important; }
}

/* login admin (overlay) centrado y sin rebalses */
#adminLogin{ align-items:center; justify-content:center; padding:16px; }
#adminLogin .nf-panel{ width:100%; max-width:420px; }
@media (max-width: 420px){
  #adminLogin .nf-head{ padding:18px 18px 0; }
  #adminLogin .nf-body{ padding:14px 18px 18px; }
  #adminLogin .nf-title{ font-size:22px; }
  #adminLogin .nf-input{ padding:.75rem .8rem; }
  #adminLogin .nf-btn{ padding:.75rem .9rem; }
}

/* toasts: en pantallas muy chicas, muévelos abajo y respeta notch */
@media (max-width: 480px){
  #toastHost{ right:12px; left:12px; top:auto; bottom:12px; width:auto; }
  .ui-toast{ border-radius:12px; }
}

/* safe-area para iOS */
@supports (padding: max(0px)){
  #toastHost{ padding-bottom: max(0px, env(safe-area-inset-bottom)); }
}




/* ==== FOOTER ESTILO INSTITUCIONAL (igual que index.html) ==== */
.govfoot {
  position: relative;
  background: radial-gradient(900px 400px at 20% -80%, rgba(12,80,128,.18), transparent 60%),
             radial-gradient(700px 300px at 100% 0%, rgba(34,197,94,.10), transparent 55%),
             linear-gradient(180deg, rgba(2,6,23,.94), rgba(2,6,23,.98));
  color: #e6eef7;
  border-top: 1px solid rgba(255,255,255,.08);
}
.govfoot .brandline {
  position: absolute; inset: 0 0 auto 0;
  height: 3px;
  background: #0c5080;
  opacity: .95;
  box-shadow: 0 0 18px rgba(12,80,128,.35);
}
.govfoot .wrap {
  max-width: 80rem;
  margin: 0 auto;
  padding: 28px 1rem 34px;
}
.govfoot .meta {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .75rem;
  font-size: .8rem;
  opacity: .9;
  text-wrap: balance;
  text-align: center;
}
.govfoot .chip {
  display: inline-flex;
  align-items: center;
  gap: .35rem;
  padding: .28rem .55rem;
  font-size: .7rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
}
.govfoot .mark {
  display: inline-grid;
  place-items: center;
  width: 60px; height: 60px;
  border-radius: 10px;
  box-shadow: 0 8px 18px rgba(12,80,128,.35);
  overflow: hidden;
  background: none;
}
.govfoot .mark img {
  width: 100%; height: 100%;
  object-fit: contain;
}
.govfoot .legal {
  margin-top: .6rem;
  font-size: .72rem;
  opacity: .75;
}

/* Responsive */
@media (max-width:640px) {
  .govfoot .wrap { padding: 18px 12px 22px; }
  .govfoot .meta { flex-direction: column; gap:.45rem; text-align:center; }
  .govfoot .mark { width:48px; height:48px; border-radius:8px; }
}

    
  </style>
</head>
<body class="min-h-full bg-base-200 text-base-content">
  <!-- Top loader -->
  <div id="topLoader" hidden></div>

  <!-- Header -->
  <header class="brand-gradient border-b border-base-300 sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./static/img/logo_brand.png" alt="Logo" class="h-11 w-11 rounded-2xl elev object-contain bg-base-100"/>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold leading-tight">Panel Admin — Estadísticas</h1>
          <p class="text-xs md:text-sm opacity-70">Datos desde <code>StrawPoll</code> SICEP.</p>
        </div>
      </div>
     <div class="flex items-center gap-2">
  <div id="adminBox" class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-xl border border-base-300 bg-base-100">
    <span class="material-symbols-rounded text-base opacity-70">shield_person</span>
    <span id="adminName" class="text-sm font-semibold">—</span>
    <a href="index.html" class="btn btn-xs btn-outline rounded-lg flex items-center gap-1">
      <span class="material-symbols-rounded text-sm">home</span> Inicio
    </a>
    <button id="btnLogout" class="btn btn-xs">Salir</button>
  </div>
</div>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle" title="Tema">
            <span class="material-symbols-rounded">dark_mode</span>
          </div>
          <ul tabindex="0" class="dropdown-content z-[60] menu p-2 shadow bg-base-100 rounded-box w-40">
            <li><a id="themeLight">Claro</a></li>
            <li><a id="themeDark">Oscuro</a></li>
            <li><a id="themeAuto">Auto</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-6">
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Votos Mujeres</div><div id="kpiWomen" class="stat-value">—</div>
        <div id="kpiWomenViews" class="stat-desc">Vistas: —</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Votos Hombres</div><div id="kpiMen" class="stat-value">—</div>
        <div id="kpiMenViews" class="stat-desc">Vistas: —</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Participantes (Mujeres)</div><div id="kpiPartWomen" class="stat-value text-primary">—</div>
        <div class="stat-desc">Poll: 7rnzVbMBanO</div></div></div>
      <div class="stats shadow bg-base-100"><div class="stat">
        <div class="stat-title">Participantes (Hombres)</div><div id="kpiPartMen" class="stat-value text-secondary">—</div>
        <div class="stat-desc">Poll: e6Z2A3DXXgN</div></div></div>
    </section>

    <!-- Gráficas -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <div class="card bg-base-100 shadow col-span-2">
        <div class="card-body">
          <h3 class="card-title">Votos por candidata/o</h3>
          <div class="chart-wrap"><canvas id="barChart" class="w-full h-full"></canvas></div>
        </div>
      </div>
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <h3 class="card-title">Distribución por género</h3>
          <div class="chart-wrap-sm"><canvas id="pieChart" class="w-full h-full"></canvas></div>
          <div class="text-xs opacity-70 mt-2">Actualizado: <span id="lastUpdate">—</span></div>
        </div>
      </div>
    </section>

    <!-- Mosaico de personas -->
    <section class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-lg">Candidatas y candidatos</h3>
        <div class="text-xs opacity-70">Ordenado por votos</div>
      </div>
      <div id="peopleGrid" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    </section>

    <!-- Tablas -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <div class="card bg-base-100 shadow"><div class="card-body">
        <h3 class="card-title">Ranking — Mujeres</h3>
        <div class="overflow-x-auto"><table class="table table-zebra">
          <thead><tr><th>#</th><th>Candidata</th><th>Votos</th></tr></thead>
          <tbody id="tblWomen"></tbody></table></div>
      </div></div>
      <div class="card bg-base-100 shadow"><div class="card-body">
        <h3 class="card-title">Ranking — Hombres</h3>
        <div class="overflow-x-auto"><table class="table table-zebra">
          <thead><tr><th>#</th><th>Candidato</th><th>Votos</th></tr></thead>
          <tbody id="tblMen"></tbody></table></div>
      </div></div>
    </section>
  </main>

  <!-- Login admin (local) -->
  <section id="adminLogin" aria-hidden="true">
    <div class="nf-panel">
      <div class="nf-head">
        <div class="flex items-center gap-2">
          <div class="nf-logo">A</div>
          <div><div class="text-[12px] opacity-80">Panel</div><div class="text-sm font-semibold">Acceso</div></div>
        </div>
        <div class="nf-title">Inicia sesión</div>
        <div class="nf-sub">Acceso restringido (local).</div>
      </div>
      <form id="loginForm" class="nf-body">
        <div class="nf-field"><label class="nf-label">Usuario</label><input id="inpUser" class="nf-input" placeholder="admin"/></div>
        <div class="nf-field"><label class="nf-label">Contraseña</label><input id="inpPass" type="password" class="nf-input" placeholder="••••••••"/></div>
        <button class="nf-btn" id="btnLogin" type="submit">Entrar</button>
      </form>
      <div class="px-6 pb-6 text-[11.5px] text-[#a9b6cd]">Los datos se leen de <code>data/stats.json</code> generado por Actions.</div>
    </div>
  </section>

 <!-- Footer -->
<footer class="govfoot mt-12">
  <div class="brandline" aria-hidden="true"></div>
  <div class="wrap">
    <div class="meta">
      <span class="mark">
        <img src="static/img/logo_brand.png" alt="Logo institucional">
      </span>
      <span>
        © 2025 — Dirección de Tecnologías de la Información y Control Penitenciario · 
        Dirección General del Sistema Penitenciario · Secretaría de Seguridad y Paz
      </span>
      <span class="chip">DTICP</span>
      <span class="chip">DGSP</span>
    </div>
    <div class="legal text-center">
      La identidad de los votantes se valida localmente para esta prueba.
    </div>
  </div>
</footer>


  <!-- ======= Sistema de toasts global ======= -->
  <div id="toastHost"></div>
  <script>
  (function initToast(){
    const host=document.getElementById('toastHost');
    window.toast=createToast; const queue=[]; let showing=0, MAX=4;

    function flush(){ while(queue.length && showing<MAX){ spawn(queue.shift()); } }
    function spawn({title,message,type='info',duration=5000,actionText=null,onAction=null}){
      showing++;
      const el=document.createElement('div'); el.className=`ui-toast ${type} enter`;
      const icon={success:'check_circle',info:'info',warn:'warning',error:'error'}[type]||'notifications';
      el.innerHTML=`
        <div class="t-icon"><span class="material-symbols-rounded">${icon}</span></div>
        <div class="t-body">${title?`<div class="t-title">${title}</div>`:''}<div class="t-msg">${message||''}</div></div>
        <div class="t-cta">${actionText?`<button class="t-action">${actionText}</button>`:''}
          <button class="t-close" title="Cerrar"><span class="material-symbols-rounded">close</span></button></div>
        <div class="t-bar"><i></i></div>`;
      const bar=el.querySelector('.t-bar>i');
      const ref=el.querySelector('.t-action')||el.querySelector('.t-icon');
      bar.style.background=getComputedStyle(ref).backgroundColor; bar.style.transform='scaleX(1)';

      let t0=performance.now(), raf;
      function tick(now){ const p=Math.min(1,(now-t0)/duration); bar.style.transform=`scaleX(${1-p})`; raf=p<1?requestAnimationFrame(tick):close(); }

      host.appendChild(el); requestAnimationFrame(()=>requestAnimationFrame(()=>tick(performance.now())));
      const closeBtn=el.querySelector('.t-close'); const actBtn=el.querySelector('.t-action');
      function close(){ cancelAnimationFrame(raf); el.classList.remove('enter'); el.classList.add('exit'); setTimeout(()=>{el.remove(); showing--; flush();},220); }
      closeBtn.addEventListener('click',close);
      if(actBtn && typeof onAction==='function'){ actBtn.addEventListener('click',()=>{ try{onAction();}finally{close();} }); }
      el.addEventListener('mouseenter',()=>cancelAnimationFrame(raf));
      el.addEventListener('mouseleave',()=>{ const remain=parseFloat(bar.style.transform.replace('scaleX(','').replace(')',''))||1;
        t0=performance.now()-duration*(1-remain); tick(performance.now()); });
    }
    function createToast(opts){ const cfg=typeof opts==='string'?{message:opts}:{...opts}; cfg.type=(cfg.type||'info').toLowerCase(); queue.push(cfg); flush(); }
  })();
  </script>

  <!-- ======= Lógica del panel ======= -->
  <script>
  /** ========= CONFIG ========= */
  const STATS_URL = './data/stats.json';
  const POLL_ID_MUJER  = "7rnzVbMBanO";
  const POLL_ID_HOMBRE = "e6Z2A3DXXgN";

  /** ========= TOP LOADER ========= */
  const topLoader=document.getElementById('topLoader'); let raf,prog=0,active=false;
  function tick(){ prog+=(95-prog)*.12+.6; topLoader.style.width=prog+'%'; raf=requestAnimationFrame(tick); }
  function showTop(){ if(active) return; active=true; topLoader.hidden=false; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; cancelAnimationFrame(raf); tick(); }
  function hideTop(){ cancelAnimationFrame(raf); topLoader.style.width='100%';
    setTimeout(()=>topLoader.classList.add('loader-fade'),40);
    setTimeout(()=>{ topLoader.hidden=true; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; active=false; },350);
  }
  document.addEventListener('readystatechange',()=>{ if(document.readyState==='interactive') showTop(); if(document.readyState==='complete') hideTop(); });

  /** ========= THEME ========= */
  function setTheme(mode){
    if(mode==='light'){ document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); toast({title:'Tema', message:'Modo claro activado', type:'info', duration:1800}); }
    else if(mode==='dark'){ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); toast({title:'Tema', message:'Modo oscuro activado', type:'info', duration:1800}); }
    else{ localStorage.removeItem('theme'); const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', prefersDark?'dark':'light'); toast({title:'Tema', message:'Modo automático', type:'info', duration:1800}); }
  }
  document.getElementById('themeLight').addEventListener('click',()=>setTheme('light'));
  document.getElementById('themeDark').addEventListener('click', ()=>setTheme('dark'));
  document.getElementById('themeAuto').addEventListener('click', ()=>setTheme('auto'));
  (function(){ const saved=localStorage.getItem('theme'); if(saved==='light'||saved==='dark') setTheme(saved); else setTheme('auto'); })();

  /** ========= LOGIN (local) ========= */
  const ADMIN_CREDENTIALS = { "admin":"admin1", "ker":"ker1","lrdra":"lrdra1","jamb":"jamb1" };
  const adminLogin = document.getElementById('adminLogin');
  const loginForm  = document.getElementById('loginForm');
  const btnLogin   = document.getElementById('btnLogin');
  const inpUser    = document.getElementById('inpUser');
  const inpPass    = document.getElementById('inpPass');
  const adminBox   = document.getElementById('adminBox');
  const adminName  = document.getElementById('adminName');

  function showAdminLogin(){ adminLogin.style.display='flex'; inpUser.focus(); }
  function hideAdminLogin(){ adminLogin.style.display='none'; }
  function paintAdmin(u){ adminBox.classList.remove('hidden'); adminName.textContent=u; }

  (function initAdminSession(){
    const raw = localStorage.getItem('admin_user');
    if(!raw){ showAdminLogin(); return; }
    try{ const u=JSON.parse(raw); if(u&&u.name){ paintAdmin(u.name); startRealtime(); } else showAdminLogin(); }
    catch{ showAdminLogin(); }
  })();

  loginForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const u=(inpUser.value||'').trim().toLowerCase();
    const p=(inpPass.value||'').trim();
    if(!ADMIN_CREDENTIALS[u] || ADMIN_CREDENTIALS[u]!==p){
      toast({ title:'Acceso inválido', message:'Usuario o contraseña incorrectos.', type:'error' });
      return;
    }
    const prev=btnLogin.innerHTML; btnLogin.disabled=true; btnLogin.innerHTML='<i class="spin"></i> Verificando…';
    setTimeout(()=>{
      localStorage.setItem('admin_user', JSON.stringify({name:u}));
      btnLogin.disabled=false; btnLogin.innerHTML=prev; hideAdminLogin(); paintAdmin(u); startRealtime();
      toast({ title:'Bienvenido', message:`Sesión iniciada como ${u}`, type:'success' });
    },650);
  });
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    localStorage.removeItem('admin_user');
    toast({ title:'Sesión cerrada', message:'Hasta luego.', type:'info', duration:1800 });
    location.reload();
  });

  /** ========= CHARTS ========= */
  let barChart, pieChart;
  function ensureCharts(){
    if(!barChart){
      barChart=new Chart(document.getElementById('barChart'),{
        type:'bar',
        data:{ labels:[], datasets:[{ label:'Votos', data:[] }]},
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }}, x:{ ticks:{ maxRotation:45, minRotation:0 } } },
          plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } }
        }
      });
    }
    if(!pieChart){
      pieChart=new Chart(document.getElementById('pieChart'),{
        type:'doughnut',
        data:{ labels:['Mujeres','Hombres'], datasets:[{ data:[0,0] }]},
        options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{ position:'bottom' } } }
      });
    }
  }

  /** ========= FOTOS ========== */
  const PHOTO_MAP = {
    "KARINA VEGA":"./static/img/1.jpg","IVETTE RODRIGUEZ":"./static/img/2.png","NOHEMI RODRIGUEZ":"./static/img/3.jpg",
    "FATIMA CAMACHO":"./static/img/4.jpg","JANETH SALINAS":"./static/img/5.png","ALEJANDRA GARCIA":"./static/img/6.jpg",
    "BRISSA GARCIA":"./static/img/7.jpg","TERESA CEJA":"./static/img/8.png","YAQUELIN VERGARA":"./static/img/9.png",
    "CLAUDIA RODRIGUEZ":"./static/img/10.png","ALVARO HERNANDEZ":"./static/img/11.jpg","UBALDO YEPEZ":"./static/img/12.png",
    "JORGE CORTÉS":"./static/img/13.jpg","MAURICIO VAZQUEZ":"./static/img/14.jpg","JOSE VARELA":"./static/img/15.png",
    "RICARDO CHAGOLLA":"./static/img/16.png","HIGINIO ROSAS":"./static/img/17.jpg","GILBERTO SANDOVAL":"./static/img/18.jpg",
    "ANTONIO CASAS":"./static/img/19.png","LUCIO CHAVEZ":"./static/img/20.png","MARCELINO MEDINA":"./static/img/21.png"
  };
  function getPhoto(name){
    return PHOTO_MAP[name] || 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" fill="%23e5e7eb"/><text x="50%" y="54%" font-size="20" text-anchor="middle" fill="%239ca3af" font-family="Inter,Arial">SIN FOTO</text></svg>`
    );
  }

  /** ========= RENDER ========= */
  function objToSortedArray(obj){
    return Object.entries(obj||{}).map(([name, votes])=>({name, votes:+votes||0}))
           .sort((a,b)=>b.votes-a.votes);
  }
  function renderTables(arr, tbodyId){
    const tb=document.getElementById(tbodyId); tb.innerHTML='';
    arr.forEach((r,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${idx+1}</td><td>${r.name}</td><td><b>${r.votes}</b></td>`;
      tb.appendChild(tr);
    });
  }
  function renderPeopleGrid(wArr, mArr){
    const grid=document.getElementById('peopleGrid'); grid.innerHTML='';
    const combined=[...wArr.map(x=>({...x,gender:'F'})), ...mArr.map(x=>({...x,gender:'M'}))].sort((a,b)=>b.votes-a.votes);
    combined.forEach((p,idx)=>{
      const el=document.createElement('div');
      el.className='person-card';
      el.innerHTML=`
        <img class="person-img" src="${getPhoto(p.name)}" alt="${p.name}"/>
        <div class="person-meta min-w-0">
          <div class="person-name truncate">${p.name}</div>
          <div class="person-sub">${p.gender==='F'?'Mujer':'Hombre'} • Votos: <b>${p.votes}</b></div>
        </div>
        <span class="ml-auto person-badge ${p.gender==='F'?'text-secondary':'text-info'}">${idx+1}</span>
      `;
      grid.appendChild(el);
    });
  }
  function updateUI(data){
    ensureCharts();

    const wArr = objToSortedArray(data.mujer);
    const mArr = objToSortedArray(data.hombre);
    const wTotal = wArr.reduce((a,b)=>a+b.votes,0);
    const mTotal = mArr.reduce((a,b)=>a+b.votes,0);

    document.getElementById('kpiWomen').textContent = wTotal;
    document.getElementById('kpiMen').textContent   = mTotal;
    document.getElementById('kpiWomenViews').textContent = `Vistas: —`;
    document.getElementById('kpiMenViews').textContent   = `Vistas: —`;
    document.getElementById('kpiPartWomen').textContent  = wTotal;
    document.getElementById('kpiPartMen').textContent    = mTotal;
    document.getElementById('lastUpdate').textContent    = data.updated_at ? new Date(data.updated_at).toLocaleString() : '—';

    const combined = [...wArr, ...mArr].sort((a,b)=>b.votes-a.votes);
    barChart.data.labels = combined.map(x=>x.name);
    barChart.data.datasets[0].data = combined.map(x=>x.votes);
    barChart.update();

    pieChart.data.datasets[0].data = [wTotal, mTotal];
    pieChart.update();

    renderTables(wArr,'tblWomen');
    renderTables(mArr,'tblMen');
    renderPeopleGrid(wArr, mArr);
  }

  /** ========= Polling al JSON ========= */
  let pollTimer=null;
  async function fetchOnce(){
    try{
      const r=await fetch(STATS_URL+'?v='+(Date.now()),{cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }catch(err){
      toast({ title:'No se pudo cargar', message:'Revisa conexión o data/stats.json', type:'warn' });
      return { updated_at:null, mujer:{}, hombre:{} };
    }
  }
  function startRealtime(){
    const run=async ()=>{
      const data=await fetchOnce();
      updateUI(data);
      if (data.updated_at){
        toast({ title:'Datos actualizados', message:new Date(data.updated_at).toLocaleString(), type:'success', duration:2000 });
      }
    };
    run();
    if(pollTimer) clearInterval(pollTimer);
    pollTimer=setInterval(run, 8000);
    toast({ title:'Tiempo real', message:'Actualización cada 8s', type:'info', duration:1800 });
  }

  /** ========= INIT ========= */
  (function(){
    const saved=localStorage.getItem('admin_user');
    if(saved){ try{ const u=JSON.parse(saved); if(u?.name){ paintAdmin(u.name); startRealtime(); } else showAdminLogin(); }catch{ showAdminLogin(); } }
  })();
  </script>
</body>
</html>
