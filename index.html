<!doctype html>
<html lang="es" data-theme="light" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Votación 2025 — Persona Servidora Pública Honesta</title>

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:['class','[data-theme="dark"]']};</script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet"/>

  <!-- Inter + Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <meta name="color-scheme" content="light dark"/>
  <style>
    :root{ --accent:#0c5080; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; }
    .grid-colx{ grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); }
    .elev{ box-shadow:0 10px 30px rgba(2,6,23,.10); }
    .card-sel{ outline:2px solid color-mix(in oklab, var(--accent) 55%, transparent); outline-offset:0; }

    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.28rem .55rem; font-size:.75rem; border-radius:999px; border:1px solid rgba(2,6,23,.15); background: rgba(255,255,255,.06); }
    .sticky-actions{ position:sticky; bottom:0; z-index:40; }
    .kbd{ display:inline-block; padding:0 .5rem; border:1px solid rgba(2,6,23,.25); border-radius:.375rem; font-size:11px; line-height:1.5; opacity:.7; background: rgba(255,255,255,.06); }

    .card-img{ width:100%; aspect-ratio:4/5; object-fit:cover; border-radius:0.75rem; }

    #topLoader{ position:fixed; top:0; left:0; height:3px; width:0; z-index:2147483647; background:#0c5080; box-shadow:0 0 8px rgba(12,80,128,.45), 0 0 2px rgba(12,80,128,.9) inset; transform:translateZ(0); transition:opacity .35s ease; }
    .loader-fade{ opacity:0; }

    #pageLoader{ position:fixed; inset:0; z-index:2147483000; display:flex; align-items:center; justify-content:center; padding: 20px; backdrop-filter: blur(6px); background: rgba(2,6,23,.55); transition: opacity .45s ease, visibility .45s ease; }
    #pageLoader.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
    .pl-card{ width:min(92vw,440px); border-radius:16px; padding:28px 24px 22px; background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border: 1px solid rgba(255,255,255,.14); box-shadow: 0 24px 64px rgba(0,0,0,.35), 0 2px 10px rgba(0,0,0,.25); color:#eaf2ff; text-align:center; }
    .pl-logo{ width:110px; height:110px; margin:0 auto 12px; position:relative; }
    .pl-logo img{ width:100%; height:100%; object-fit:contain; filter: drop-shadow(0 12px 24px rgba(12,80,128,.35)); }
    .pl-orbs::before, .pl-orbs::after{ content:""; position:absolute; border-radius:9999px; inset:auto; animation: orb 3.2s ease-in-out infinite; filter: blur(10px); }
    .pl-orbs::before{ width:32px; height:32px; left:-8px; top:-8px; background:#3b82f6aa; }
    .pl-orbs::after{ width:26px; height:26px; right:-8px; bottom:-8px; background:#22d3ee88; animation-direction:reverse; }
    @keyframes orb{ 50%{ transform: translate3d(6px,-4px,0) scale(1.08); } }
    .pl-title{ font-weight:800; font-size:20px; margin-top:6px; }
    .pl-sub{ opacity:.85; font-size:13px; margin-top:2px; }
    .pl-bar{ margin:14px auto 4px; width:180px; height:6px; border-radius:999px; background:rgba(255,255,255,.16); overflow:hidden; }
    .pl-bar i{ display:block; height:100%; width:60%; border-radius:999px; background:#0c5080; animation: bar 1.4s ease-in-out infinite; }
    @keyframes bar{ 50%{ transform: translateX(80%)} 100%{ transform: translateX(0)} }

    /* Rule Banner */
    .rule-card{ border-radius:18px; border:1px solid color-mix(in oklab, var(--accent) 22%, transparent);
      background: radial-gradient(1200px 600px at 0% 0%, color-mix(in oklab, var(--accent) 15%, transparent), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(6px); display:grid; grid-template-columns: 1fr auto; align-items:center; gap:18px; padding:18px 20px; position:relative; }
    .rule-ribbon{ display:none !important; }
    .rule-icon{ width:44px; height:44px; border-radius:12px; display:grid; place-items:center; color:white;
      background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 92%, #0b1220 8%), #0c5080);
      box-shadow: 0 12px 30px color-mix(in oklab, var(--accent) 35%, transparent); }
    .pill{ display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .65rem; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .rule-state{ display:inline-flex; align-items:center; gap:.5rem; font-size:12px; padding:.35rem .55rem; border-radius:10px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
    .rule-state .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; background:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,.12); }
    #ruleBanner.alert-success .rule-state .dot{ background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.14); }

    /* NAVBAR */
    .govbar{ position: sticky; top: 0; z-index: 30; background: rgba(255,255,255,.85);
      backdrop-filter: saturate(1.1) blur(8px); -webkit-backdrop-filter: saturate(1.1) blur(8px);
      border-bottom: 1px solid rgb(229 231 235); }
    [data-theme="dark"] .govbar{ background: rgba(17,24,39,.75); border-bottom-color: rgb(55 65 81); }
    .govbrand{ display:flex; align-items:center; gap:.75rem; min-width:0; }
    .govtitle{ font-weight: 800; line-height: 1.1; font-size: clamp(1rem, 2vw, 1.375rem); }
    .govsub{ font-size: .75rem; opacity:.75; }
    .govlogo{ height: 44px; width:auto; border-radius: .75rem; box-shadow: 0 6px 16px rgba(2,6,23,.12); }

    /* FOOTER deep */
    .govfoot{ position: relative;
      background: radial-gradient(900px 400px at 20% -80%, rgba(12,80,128,.18), transparent 60%),
                 radial-gradient(700px 300px at 100% 0%, rgba(34,197,94,.10), transparent 55%),
                 linear-gradient(180deg, rgba(2,6,23,.94), rgba(2,6,23,.98));
      color: #e6eef7; border-top: 1px solid rgba(255,255,255,.08); }
    .govfoot .brandline{ position:absolute; inset:0 0 auto 0; height:3px; background:#0c5080; opacity:.95; box-shadow:0 0 18px rgba(12,80,128,.35); }
    .govfoot .wrap{ max-width: 80rem; margin: 0 auto; padding: 28px 1rem 34px; }
    .govfoot .meta{ display:flex; align-items:center; justify-content:center; gap:.75rem; font-size:.8rem; opacity:.9; text-wrap:balance; text-align:center; }
    .govfoot .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.28rem .55rem; font-size:.7rem; border-radius:999px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); }
    .govfoot .mark{ display:inline-grid; place-items:center; width:60px; height:60px; border-radius:10px; box-shadow: 0 8px 18px rgba(12,80,128,.35); overflow:hidden; background:none; }
    .govfoot .mark img{ width:100%; height:100%; object-fit:contain; }
    .govfoot .legal{ margin-top:.6rem; font-size:.72rem; opacity:.75; }

    @media (max-width:640px){ .govsub{ display:none; } .govfoot .wrap{ padding:22px 1rem 26px; } .govfoot .meta{ flex-direction:column; gap:.5rem; } }

    #toastHost{ position: fixed; right: 16px; top: 16px; z-index: 60; display: grid; gap: 10px; width: min(92vw, 360px); }
    .ui-toast{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; background: var(--toast-bg); color: var(--toast-fg); border:1px solid var(--toast-border); border-radius:14px; padding:12px 12px; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: var(--toast-shadow); overflow:hidden; }
    .ui-toast .t-icon{ width:28px; height:28px; border-radius:10px; display:grid; place-items:center; color:#fff }
    .ui-toast .t-title{ font-weight:800; font-size:14px; line-height:1.1 }
    .ui-toast .t-msg{ font-size:12.5px; opacity:.9; margin-top:2px; word-wrap:break-word }
    .ui-toast .t-close{ border:0; background:transparent; color:inherit; opacity:.7; cursor:pointer }
    .ui-toast .t-close:hover{ opacity:1 }
    .ui-toast .t-action{ margin-left:6px; border:0; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer }
    .ui-toast .t-bar{ position:relative; grid-column:1 / -1; height:3px; margin-top:8px; background:linear-gradient(90deg, rgba(255,255,255,.15), transparent) }
    .ui-toast .t-bar > i{ position:absolute; inset:0; transform-origin:left }
    .ui-toast.success .t-icon, .ui-toast.success .t-action{ background:#16a34a }
    .ui-toast.info .t-icon, .ui-toast.info .t-action{ background:#0ea5e9 }
    .ui-toast.warn .t-icon, .ui-toast.warn .t-action{ background:#f59e0b }
    .ui-toast.error .t-icon, .ui-toast.error .t-action{ background:#ef4444 }
    .ui-toast{ transform: translateY(-8px); opacity:0 }
    .ui-toast.enter{ animation: toastIn .28s ease forwards }
    .ui-toast.exit{ animation: toastOut .22s ease forwards }
    @keyframes toastIn{ to{ transform:none; opacity:1 } }
    @keyframes toastOut{ to{ transform: translateY(-8px); opacity:0 } }

    /* === FIX PACK MÓVIL === */
    @media (max-width: 768px){ .elev{ box-shadow:0 8px 22px rgba(2,6,23,.10) } .govbar .max-w-7xl{ padding-left:12px; padding-right:12px } .govlogo{ height:36px; border-radius:.6rem } .govtitle{ font-size:clamp(.95rem, 3.5vw, 1.1rem) } }
    @media (max-width: 640px){
      .rule-card{ grid-template-columns: 1fr; gap:12px; padding:14px 14px; border-radius:14px;
        background: radial-gradient(600px 300px at 0% 0%, color-mix(in oklab, var(--accent) 12%, transparent), transparent 55%), linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); }
      .rule-icon{ width:38px; height:38px; border-radius:10px }
      .rule-state{ align-self:flex-start }
      .rule-card .pill{ font-size:11px; padding:.28rem .5rem }
      .input.input-bordered{ padding-left:.6rem }
      .kbd{ display:none }
      .join .btn{ min-width:auto; padding-left:.9rem; padding-right:.9rem }
      .grid-colx{ grid-template-columns: repeat(2, minmax(0,1fr)) !important }
    }
    @media (max-width: 420px){
      .grid-colx{ gap:.6rem !important }
      .card .card-body{ padding:10px 12px 12px }
      .card-img{ border-radius:.6rem }
      .card-title{ font-size:.95rem }
      .chip{ font-size:11px; padding:.22rem .45rem }
    }
    .sticky-actions{ padding-bottom: max(10px, env(safe-area-inset-bottom)) }
    #sessionHint{ margin-top:.35rem; font-size:11.5px }
    @media (max-width: 640px){ #btnAdmin{ padding-left:.6rem; padding-right:.6rem } }
  </style>
</head>
<body class="min-h-full bg-base-200 text-base-content">
  <!-- Top loader -->
  <div id="topLoader" hidden></div>

  <!-- Toast host -->
  <div id="toastHost"></div>

  <!-- Loader central -->
  <div id="pageLoader" aria-hidden="true">
    <div class="pl-card">
      <div class="pl-logo pl-orbs"><img src="static/img/logo2.png" alt="Cargando…"/></div>
      <div class="pl-title">Preparando tu votación…</div>
      <div class="pl-sub">Validando recursos y UI</div>
      <div class="pl-bar"><i></i></div>
    </div>
  </div>

  <!-- Header -->
  <header class="govbar">
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-3 flex items-center justify-between">
      <div class="govbrand">
        <img src="static/img/logo2.png" alt="Logo institucional" class="govlogo">
        <div class="min-w-0">
          <h1 class="govtitle truncate text-base-content">Votación 2025 — Persona Servidora Pública Honesta</h1>
          <p class="govsub">Seleccione exactamente <b>1 mujer</b> y <b>1 hombre</b>. Voto único por persona.</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <!-- Admin visible SIEMPRE -->
        <a id="btnAdmin" href="admin.html" class="btn btn-sm btn-outline rounded-xl" title="Resultados en tiempo real">
          <span class="material-symbols-rounded text-base">monitoring</span> Resultados (admin)
        </a>

        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle" title="Tema">
            <span class="material-symbols-rounded">dark_mode</span>
          </div>
          <ul tabindex="0" class="dropdown-content z-[60] menu p-2 shadow bg-base-100 rounded-box w-40">
            <li><a id="themeLight">Claro</a></li>
            <li><a id="themeDark">Oscuro</a></li>
            <li><a id="themeAuto">Auto</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- Avisos -->
  <section class="max-w-7xl mx-auto px-4 md:px-8 mt-6">
    <div id="ruleBanner" class="alert alert-info elev rule-card overflow-hidden">
      <div class="flex-1 flex items-start gap-4">
        <div class="rule-icon"><span class="material-symbols-rounded">gavel</span></div>
        <div class="min-w-0">
          <h3 class="font-extrabold text-base md:text-lg leading-tight tracking-tight">Reglas de la boleta</h3>
          <p class="text-sm opacity-85 mt-0.5">Debes elegir <b>exactamente 1 mujer</b> y <b>1 hombre</b>. No necesitas iniciar sesión para votar.</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="pill">Duplicidad bloqueada</span>
            <span class="pill">Anónimo al público</span>
            <span class="pill">Verificación local</span>
          </div>
        </div>
      </div>
      <div class="shrink-0 flex flex-col items-end gap-2">
        <div class="rule-state"><span class="dot"></span><span class="label">Paridad requerida</span></div>
        <button class="btn btn-sm rounded-xl rule-cta"><span class="material-symbols-rounded text-base">visibility</span> Ver reglas</button>
      </div>
    </div>
  </section>

  <!-- Controles -->
  <section class="max-w-7xl mx-auto px-4 md:px-8 mt-6 grid gap-3 md:grid-cols-2">
    <label class="input input-bordered bg-base-100 flex items-center gap-2 elev">
      <span class="material-symbols-rounded opacity-70">search</span>
      <input id="search" type="text" class="grow" placeholder="Buscar candidata/o por nombre (⌘/Ctrl+K)"/>
      <kbd class="kbd hidden md:inline">⌘/Ctrl</kbd><kbd class="kbd hidden md:inline">K</kbd>
    </label>
    <div class="bg-base-100 rounded-2xl p-2 elev flex items-center justify-between flex-wrap gap-2">
      <div class="flex items-center gap-2 text-sm opacity-70"><span class="material-symbols-rounded">tune</span> Filtro rápido</div>
      <div class="join">
        <input class="join-item btn btn-sm" type="radio" name="filtroGenero" id="filtroTodos" checked>
        <label class="join-item btn btn-sm" for="filtroTodos">Todos</label>
        <input class="join-item btn btn-sm" type="radio" name="filtroGenero" id="filtroMujer">
        <label class="join-item btn btn-sm" for="filtroMujer">Mujer</label>
        <input class="join-item btn btn-sm" type="radio" name="filtroGenero" id="filtroHombre">
        <label class="join-item btn btn-sm" for="filtroHombre">Hombre</label>
      </div>
    </div>
  </section>

  <!-- Listas -->
  <main class="max-w-7xl mx-auto px-4 md:px-8 mt-6 grid gap-6 lg:grid-cols-2">
    <section aria-labelledby="hdrMujer">
      <div class="flex items-baseline justify-between mb-2">
        <h2 id="hdrMujer" class="text-lg font-semibold">Candidatas (Mujer)</h2>
        <span class="chip">Selecciona 1</span>
      </div>
      <div id="listaMujer" class="grid gap-4 grid-colx"></div>
    </section>
    <section aria-labelledby="hdrHombre">
      <div class="flex items-baseline justify-between mb-2">
        <h2 id="hdrHombre" class="text-lg font-semibold">Candidatos (Hombre)</h2>
        <span class="chip">Selecciona 1</span>
      </div>
      <div id="listaHombre" class="grid gap-4 grid-colx"></div>
    </section>
  </main>

  <!-- Acciones -->
  <div class="sticky-actions mt-8">
    <div class="max-w-7xl mx-auto px-4 md:px-8">
      <div class="bg-base-100 rounded-2xl border border-base-300 elev">
        <div class="p-4 md:p-6 grid gap-4 md:grid-cols-[1fr_auto] items-center">
          <div class="flex items-center gap-4">
            <div class="avatar placeholder">
              <div class="bg-primary text-primary-content rounded-xl w-12 grid place-items-center">
                <span class="material-symbols-rounded">how_to_vote</span>
              </div>
            </div>
            <div>
              <h3 class="font-semibold">Resumen de tu boleta</h3>
              <ul id="seleccionResumen" class="text-sm opacity-90 mt-1 space-y-1"></ul>
              <div class="text-xs opacity-60">Debes tener 2 seleccionados: 1 mujer + 1 hombre.</div>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="btnLimpiar" class="btn btn-ghost rounded-xl">Limpiar</button>
            <button id="btnPreview" class="btn btn-outline rounded-xl">Previsualizar</button>
            <!-- 🔴 botón reiniciar (solo admin) -->
            <button id="btnReset" class="btn btn-outline btn-error rounded-xl hidden" title="Reinicia los conteos de voto">
              <span class="material-symbols-rounded">restart_alt</span> Reiniciar votos
            </button>
            <button id="btnEnviar" class="btn btn-primary rounded-xl" disabled>
              <span class="material-symbols-rounded">how_to_vote</span> Enviar voto
            </button>
          </div>
        </div>
      </div>
      <div class="text-xs opacity-60 mt-2 px-1" id="sessionHint">No necesitas iniciar sesión para votar.</div>
      <pre id="payload" class="mt-3 text-xs bg-base-200 p-3 rounded-2xl overflow-auto hidden"></pre>
    </div>
  </div>

  <!-- Modal preview -->
  <dialog id="modalPreview" class="modal">
    <div class="modal-box max-w-xl">
      <h3 class="font-bold text-lg">Confirmar tu boleta</h3>
      <p class="text-sm opacity-80 mt-1">Revisa que tu selección cumpla la regla de paridad antes de enviar.</p>
      <div class="divider my-3"></div>
      <ul id="previewList" class="space-y-2 text-sm"></ul>
      <div class="divider my-3"></div>
      <div class="flex items-center justify-between">
        <div class="text-xs opacity-70" id="whoami"></div>
        <div class="modal-action">
          <form method="dialog"><button class="btn btn-ghost rounded-xl">Cancelar</button></form>
          <button id="btnConfirm" class="btn btn-primary rounded-xl"><span class="material-symbols-rounded">how_to_vote</span> Confirmar y enviar</button>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Footer -->
  <footer class="govfoot mt-12">
    <div class="brandline" aria-hidden="true"></div>
    <div class="wrap">
      <div class="meta">
        <span class="mark"><img src="static/img/logo_brand.png" alt="Logo institucional"></span>
        <span>© 2025 — Dirección de Tecnologías de la Información y Control Penitenciario · Dirección General del Sistema Penitenciario · Secretaría de Seguridad y Paz</span>
        <span class="chip">DTICP</span>
        <span class="chip">DGSP</span>
      </div>
      <div class="legal text-center">La identidad de los votantes no se muestra públicamente.</div>
    </div>
  </footer>

<script>
/** =========================
 * CONFIG
 * ========================= */
const POLL_ID_MUJER  = "7rnzVbMBanO";
const POLL_ID_HOMBRE = "e6Z2A3DXXgN";

// Base del worker — cambia solo esto si te mueves de dominio
const PROXY_BASE_URL = "https://vote-proxy.oimirandao.workers.dev";
// Endpoints
const PROXY_VOTE_URL  = PROXY_BASE_URL + "/vote?debug=1";
const RESET_URL       = PROXY_BASE_URL + "/reset";   // <-- POST para reiniciar (ajusta si tu worker usa otra ruta)
const MODE_URL        = "./data/mode.json";          // open/close control

const OPTION_IDS = {
  M:{ "ALVARO HERNANDEZ":"B2ZBawNAQgJ","UBALDO YEPEZ":"61gDkX6Kznw","JORGE CORTÉS":"mpnbbvJMPn5","MAURICIO VAZQUEZ":"jVyGeXxokg7","JOSE VARELA":"kogjGWq81Z6","RICARDO CHAGOLLA":"ajnE7Xx4mZW","HIGINIO ROSAS":"YVyPNXwb3gN","GILBERTO SANDOVAL":"jVyGeX1qkg7","ANTONIO CASAS":"NPgxGa81rn2","LUCIO CHAVEZ":"wAg3MOwbKy8","MARCELINO MEDINA":"6QnM5Xwqane" },
  F:{ "KARINA VEGA":"NoZrRwPkBZ3","IVETTE RODRIGUEZ":"bVg8AaGqbZY","NOHEMI RODRIGUEZ":"xVg7MzQGOyr","FATIMA CAMACHO":"QrgeGJmELyp","JANETH SALINAS":"wAg3MODddy8","ALEJANDRA GARCIA":"DwyodpP8YnA","BRISSA GARCIA":"xVg7Mzwbzyr","TERESA CEJA":"3RnYb6YR9ge","YAQUELIN VERGARA":"QrgeGJLMQyp","CLAUDIA RODRIGUEZ":"PKglGYB9onp" }
};

const CANDIDATURAS = [
  { id:'F-01', nombre:'KARINA VEGA',       genero:'F', foto:'static/img/1.jpg',  lugar:'CEPRERESO SAN FELIPE' },
  { id:'F-02', nombre:'IVETTE RODRIGUEZ',  genero:'F', foto:'static/img/2.png',  lugar:'CEPRERESO GUANAJUATO' },
  { id:'F-03', nombre:'NOHEMI RODRIGUEZ',  genero:'F', foto:'static/img/3.jpg',  lugar:'CEPRESO CELAYA' },
  { id:'F-04', nombre:'FATIMA CAMACHO',    genero:'F', foto:'static/img/4.jpg',  lugar:'CEPRERESO PÉNJAMO' },
  { id:'F-05', nombre:'JANETH SALINAS',    genero:'F', foto:'static/img/5.png',  lugar:'CEPRERESO VALLE DE SANTIAGO FEMENIL' },
  { id:'F-06', nombre:'ALEJANDRA GARCIA',  genero:'F', foto:'static/img/6.jpg',  lugar:'CEPRERESO LEÓN' },
  { id:'F-07', nombre:'BRISSA GARCIA',     genero:'F', foto:'static/img/7.jpg',  lugar:'CEPRERESO SAN MIGUEL DE ALLENDE' },
  { id:'F-08', nombre:'TERESA CEJA',       genero:'F', foto:'static/img/8.png',  lugar:'CEPRERESO VALLE DE SANTIAGO VARONIL' },
  { id:'F-09', nombre:'YAQUELIN VERGARA',  genero:'F', foto:'static/img/9.png',  lugar:'CEPRERESO ACÁMBARO' },
  { id:'F-10', nombre:'CLAUDIA RODRIGUEZ', genero:'F', foto:'static/img/10.png', lugar:'CEPRERESO SALAMANCA' },
  { id:'M-01', nombre:'ALVARO HERNANDEZ',  genero:'M', foto:'static/img/11.jpg', lugar:'CEPRERESO SAN FELIPE' },
  { id:'M-02', nombre:'UBALDO YEPEZ',      genero:'M', foto:'static/img/12.png', lugar:'CEPRERESO GUANAJUATO' },
  { id:'M-03', nombre:'JORGE CORTÉS',      genero:'M', foto:'static/img/13.jpg', lugar:'CEPRESO CELAYA' },
  { id:'M-04', nombre:'MAURICIO VAZQUEZ',  genero:'M', foto:'static/img/14.jpg', lugar:'CEPRERESO PÉNJAMO' },
  { id:'M-05', nombre:'JOSE VARELA',       genero:'M', foto:'static/img/15.png', lugar:'CEPRERESO VALLE DE SANTIAGO VARONIL' },
  { id:'M-06', nombre:'RICARDO CHAGOLLA',  genero:'M', foto:'static/img/CHA.png', lugar:'CEPRERESO LEÓN' },
  { id:'M-07', nombre:'HIGINIO ROSAS',     genero:'M', foto:'static/img/17.png', lugar:'CEPRERESO SALAMANCA' },
  { id:'M-08', nombre:'GILBERTO SANDOVAL', genero:'M', foto:'static/img/18.png', lugar:'CEPRERESO VALLE DE SANTIAGO VARONIL' },
  { id:'M-09', nombre:'ANTONIO CASAS',     genero:'M', foto:'static/img/casas.png', lugar:'CEPRERESO SAN MIGUEL DE ALLENDE' },
  { id:'M-10', nombre:'LUCIO CHAVEZ',      genero:'M', foto:'static/img/20.png', lugar:'CEPRESP IRAPUATO' },
  { id:'M-11', nombre:'MARCELINO MEDINA',  genero:'M', foto:'static/img/21.png',  lugar:'CEPRERESO ACÁMBARO' }
];

// ===== Helpers / estado (sin sesión) =====
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const state={ seleccion:{F:null,M:null}, filtro:'ALL', q:'' };

// ===== Admin gate (para mostrar botón Reset sin exponerlo al público) =====
(function setupAdminFlag(){
  const q = new URLSearchParams(location.search);
  if (q.get('admin') === '1') localStorage.setItem('is_admin', '1');
})();
function isAdmin(){ return localStorage.getItem('is_admin') === '1'; }

// ===== Modo remoto (open/close) =====
const mode = { open: true, message: 'Votación abierta.' };

function paintModeUI(){
  const banner = document.getElementById('ruleBanner');
  const label  = banner?.querySelector('.label');
  const dot    = banner?.querySelector('.dot');

  if (mode.open){
    banner.className = 'alert alert-success elev rule-card overflow-hidden';
    if (label) label.textContent = 'Paridad requerida • Votación ABIERTA';
    if (dot)   dot.style.background = '#22c55e';
    banner.querySelector('div > div')?.querySelector('p')?.remove();
    banner.querySelector('div > div')?.insertAdjacentHTML('beforeend', `<p class="text-sm opacity-75 mt-1">${mode.message || 'Listo: regla cumplida (1 mujer + 1 hombre).'}</p>`);
  }else{
    banner.className = 'alert alert-warning elev rule-card overflow-hidden';
    if (label) label.textContent = 'Votación CERRADA por el administrador';
    if (dot)   dot.style.background = '#f59e0b';
    banner.querySelector('div > div')?.querySelector('p')?.remove();
    banner.querySelector('div > div')?.insertAdjacentHTML('beforeend', `<p class="text-sm opacity-75 mt-1">${mode.message || 'Temporalmente cerrada. Inténtalo más tarde.'}</p>`);
  }
  updateButtons();
}

async function fetchModeOnce(){
  try{
    const r = await fetch(MODE_URL + '?v=' + Date.now(), { cache: 'no-store' });
    if (!r.ok) throw 0;
    const data = await r.json();
    const changed = (data?.open !== mode.open) || (data?.message !== mode.message);
    mode.open    = (typeof data?.open === 'boolean') ? data.open : true;
    mode.message = (typeof data?.message === 'string') ? data.message : 'Votación abierta.';
    if (changed) paintModeUI();
  }catch{
    const changed = (mode.open !== true);
    mode.open = true;
    if (changed) paintModeUI();
  }
}

let modeTimer = null;
function startModePolling(){
  fetchModeOnce();
  if (modeTimer) clearInterval(modeTimer);
  modeTimer = setInterval(fetchModeOnce, 7000);
}

// ===== TopLoader =====
const topLoader=document.getElementById('topLoader'); let raf,prog=0,active=false;
function tick(){ prog+=(95-prog)*.12+.6; topLoader.style.width=prog+'%'; raf=requestAnimationFrame(tick); }
function showTop(){ if(active) return; active=true; topLoader.hidden=false; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; cancelAnimationFrame(raf); tick(); }
function hideTop(){ cancelAnimationFrame(raf); topLoader.style.width='100%'; setTimeout(()=>topLoader.classList.add('loader-fade'),40); setTimeout(()=>{ topLoader.hidden=true; topLoader.classList.remove('loader-fade'); topLoader.style.width='0%'; prog=0; active=false; },350); }

// ===== Loader orchestration =====
const pageLoader = document.getElementById('pageLoader');
(function mountPageLoader(){
  if (!pageLoader) return;
  const MIN_MS = 900, HARD_TIMEOUT = 3500, start = performance.now();
  showTop();
  const closeBoth = () => { pageLoader.classList.add('hidden'); hideTop(); };
  const scheduleClose = () => { const elapsed = performance.now() - start; const wait = Math.max(0, MIN_MS - elapsed); setTimeout(closeBoth, wait); };
  if (document.readyState === 'interactive' || document.readyState === 'complete') scheduleClose();
  else document.addEventListener('DOMContentLoaded', scheduleClose, { once:true });
  window.addEventListener('load', scheduleClose, { once:true });
  setTimeout(()=>{ if (document.body.contains(pageLoader)) pageLoader.remove(); hideTop(); }, HARD_TIMEOUT);
})();

// ===== Tema =====
function setTheme(modeTheme){
  if(modeTheme==='light'){ document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); }
  else if(modeTheme==='dark'){ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
  else{ localStorage.removeItem('theme'); const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark?'dark':'light'); }
}
$('#themeLight')?.addEventListener('click',()=>setTheme('light'));
$('#themeDark')?.addEventListener('click', ()=>setTheme('dark'));
$('#themeAuto')?.addEventListener('click', ()=>setTheme('auto'));
(function(){ const saved=localStorage.getItem('theme'); if(saved==='light'||saved==='dark') setTheme(saved); else setTheme('auto'); })();

// ===== Render tarjetas =====
function displayLugar(c){ return (c.lugar && c.lugar.trim()) ? c.lugar : c.id; }
function isSelected(c){ const s=state.seleccion[c.genero]; return !!(s && s.id===c.id); }
function cardTemplate(c){
  const badge = c.genero==='F' ? 'badge-secondary' : 'badge-info';
  return `
  <article class="card bg-base-100 border border-base-300 hover:border-primary/40 hover:translate-y-[-1px] transition-all duration-150 ${isSelected(c)?'card-sel':''}">
    <figure class="px-4 pt-4"><img class="card-img" src="${c.foto}" alt="${c.nombre}"/></figure>
    <div class="card-body">
      <h3 class="card-title text-base">${c.nombre}</h3>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="badge ${badge}">${c.genero==='F'?'Mujer':'Hombre'}</span>
        <span class="chip" title="Municipio/CERESO">${displayLugar(c)}</span>
      </div>
      <div class="card-actions mt-3">
        <button class="btn ${isSelected(c)?'btn-error':'btn-primary'} btn-sm select-btn">
          ${isSelected(c)?'Quitar':'Seleccionar'}
        </button>
      </div>
    </div>
  </article>`;
}
function renderListas(){
  const contF=$('#listaMujer'), contM=$('#listaHombre'); contF.innerHTML=''; contM.innerHTML='';
  const q=state.q.trim().toLowerCase();
  for(const c of CANDIDATURAS){
    if(state.filtro==='F' && c.genero!=='F') continue;
    if(state.filtro==='M' && c.genero!=='M') continue;
    if(q && !c.nombre.toLowerCase().includes(q)) continue;
    const wrap=document.createElement('div'); wrap.innerHTML=cardTemplate(c);
    wrap.querySelector('.select-btn').addEventListener('click', ()=>toggleSelect(c));
    (c.genero==='F'?contF:contM).appendChild(wrap.firstElementChild);
  }
  renderResumen(); updateButtons();
}
function toggleSelect(c){ const cur=state.seleccion[c.genero]; state.seleccion[c.genero]=(cur && cur.id===c.id)?null:{id:c.id, nombre:c.nombre, lugar: displayLugar(c)}; renderListas(); }
function renderResumen(){
  const ul=$('#seleccionResumen'), f=state.seleccion.F, m=state.seleccion.M;
  ul.innerHTML=`<li>🟣 Mujer: <b>${f?f.nombre:'—'}</b>${f?` <span class="chip">${f.lugar||f.id}</span>`:''}</li>
                <li>🔵 Hombre: <b>${m?m.nombre:'—'}</b>${m?` <span class="chip">${m.lugar||m.id}</span>`:''}</li>`;
  const ok=!!(f&&m); const banner=$('#ruleBanner');
  banner.className=`alert ${ok?'alert-success':'alert-info'} elev rule-card overflow-hidden`;
  const text=ok?'Listo: regla cumplida (1 mujer + 1 hombre).':'Debes elegir exactamente 1 mujer y 1 hombre.';
  banner.querySelector('div > div')?.querySelector('p')?.remove();
  banner.querySelector('div > div')?.insertAdjacentHTML('beforeend', `<p class="text-sm opacity-75 mt-1">${text}</p>`);
  const payload = ok ? { mujer:f.nombre, mujer_lugar:f.lugar||f.id, hombre:m.nombre, hombre_lugar:m.lugar||m.id, ts:new Date().toISOString() } : { seleccion:null };
  $('#payload').textContent = JSON.stringify(payload,null,2);
}
function updateButtons(){
  const ready=!!(state.seleccion.F && state.seleccion.M);
  $('#btnEnviar').disabled = !(ready && mode.open);
  $('#sessionHint').textContent = mode.open
    ? 'No necesitas iniciar sesión para votar.'
    : 'Votación cerrada por el administrador.';
  // Mostrar / ocultar Reset según admin
  const resetBtn = $('#btnReset');
  if (resetBtn){ resetBtn.classList.toggle('hidden', !isAdmin()); }
}

// ===== Búsqueda / Filtro / Hotkey =====
$('#search').addEventListener('input', e=>{ state.q=e.target.value||''; renderListas(); });
$$('input[name="filtroGenero"]').forEach(r=>r.addEventListener('change', ()=>{ state.filtro=$('#filtroMujer').checked?'F':($('#filtroHombre').checked?'M':'ALL'); renderListas(); }));
window.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); } });

// ======== ENVÍO (2 POST secuenciales; headers mínimos; normalización de nombres) ========
function withTimeout(promise, ms=12000){
  let t; return Promise.race([promise, new Promise((_,rej)=> t=setTimeout(()=>rej(new Error('timeout')), ms))]).finally(()=> clearTimeout(t));
}
const normalize = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim().toUpperCase();
function getOptionId(genero, nombre){
  const table = genero==='F' ? OPTION_IDS.F : OPTION_IDS.M;
  if (table[nombre]) return table[nombre];
  const n = normalize(nombre);
  for (const [k,v] of Object.entries(table)){ if (normalize(k)===n) return v; }
  return null;
}
async function voteOnce(pollId, optionId){
  const body = JSON.stringify({ poll_id: pollId, option_id: optionId });
  const res = await withTimeout(fetch(PROXY_VOTE_URL, {
    method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
    body, mode:'cors', credentials:'omit', cache:'no-store'
  }));
  const text = await res.text().catch(()=> '');
  if(!res.ok){ throw new Error((text && text.length<300 ? text : `HTTP ${res.status}`) || 'Error del proxy'); }
  try{ return JSON.parse(text); }catch{ return { ok:true, raw:text }; }
}

// Preview
document.getElementById('btnEnviar').addEventListener('click', ()=>{
  if (!mode.open){ alert('La votación está cerrada en este momento por el administrador.'); return; }
  const f=state.seleccion.F, m=state.seleccion.M; if(!(f&&m)) return alert('Falta seleccionar 1 mujer y 1 hombre.');
  $('#previewList').innerHTML = `<li>🟣 <b>Mujer</b>: ${f.nombre} <span class="chip">${f.lugar||f.id}</span></li>
                                 <li>🔵 <b>Hombre</b>: ${m.nombre} <span class="chip">${m.lugar||m.id}</span></li>`;
  $('#whoami').textContent = '';
  document.getElementById('modalPreview').showModal();
});

document.getElementById('btnPreview').addEventListener('click', ()=>{
  const f=state.seleccion.F, m=state.seleccion.M; if(!(f&&m)) return alert('Falta seleccionar 1 mujer y 1 hombre.');
  $('#previewList').innerHTML = `<li>🟣 <b>Mujer</b>: ${f.nombre} <span class="chip">${f.lugar||f.id}</span></li>
                                 <li>🔵 <b>Hombre</b>: ${m.nombre} <span class="chip">${m.lugar||m.id}</span></li>`;
  $('#whoami').textContent = '';
  document.getElementById('modalPreview').showModal();
});

// Confirmar y enviar
document.getElementById('btnConfirm').addEventListener('click', async ()=>{
  if (!mode.open){ alert('La votación se cerró mientras confirmabas. Intenta más tarde.'); return; }
  const f=state.seleccion.F, m=state.seleccion.M; if(!(f&&m)) return;

  const optIdF = getOptionId('F', f.nombre);
  const optIdM = getOptionId('M', m.nombre);
  if(!optIdF || !optIdM){ alert('Faltan option_id reales en OPTION_IDS (revisa nombres/acentos).'); return; }

  const btn = document.getElementById('btnConfirm'); const prev = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Enviando…';

  try{
    await voteOnce(POLL_ID_MUJER,  optIdF);
    await voteOnce(POLL_ID_HOMBRE, optIdM);

    document.getElementById('modalPreview').close();
    alert('¡Voto registrado en ambas encuestas! 🎉');

    state.seleccion.F=null; state.seleccion.M=null; renderListas();
  }catch(err){
    alert('No se pudo enviar el voto:\n' + (err?.message || String(err)));
  }finally{
    btn.disabled=false; btn.innerHTML=prev;
  }
});

// ===== Reiniciar Votaciones (solo admin) =====
async function resetVotes(){
  if (!isAdmin()){
    alert('Acceso restringido. Activa modo admin con ?admin=1 una vez.');
    return;
  }
  if (!confirm('¿Seguro que quieres reiniciar los conteos de voto? Esta acción no se puede deshacer.')){
    return;
  }
  const btn = document.getElementById('btnReset'); const prev = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Reiniciando…';
  try{
    const res = await fetch(RESET_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
      body: JSON.stringify({ action:'reset' }),
      mode:'cors', credentials:'omit', cache:'no-store'
    });
    const text = await res.text().catch(()=> '');
    if(!res.ok){ throw new Error((text && text.length<300 ? text : `HTTP ${res.status}`) || 'Error al resetear'); }

    // Feedback
    toast({ title:'Reinicio completado', message:'Se limpiaron los conteos.', type:'success', duration:2200 });
    // Limpia selección local
    state.seleccion.F=null; state.seleccion.M=null; renderListas();
  }catch(err){
    alert('No se pudo reiniciar:\n' + (err?.message || String(err)));
  }finally{
    btn.disabled=false; btn.innerHTML=prev;
  }
}
document.getElementById('btnReset').addEventListener('click', resetVotes);

document.getElementById('btnLimpiar').addEventListener('click', ()=>{ state.seleccion.F=null; state.seleccion.M=null; renderListas(); });

// INIT
(function init(){
  renderListas();
  updateButtons();
  paintModeUI();
  startModePolling();
  // pinta botón reset si admin
  if (isAdmin()){ const b=$('#btnReset'); if (b) b.classList.remove('hidden'); }
})();

// ===== Toast minimal (opcional) =====
(function initToast(){
  if (document.getElementById('toastHost')) { window.toast = createToast; }
  const queue = []; let showing = 0, MAX = 4;
  function flush(){ while (queue.length && showing < MAX) spawn(queue.shift()); }
  function spawn({title, message, type='info', duration=5000, actionText=null, onAction=null}){
    showing++;
    const el = document.createElement('div');
    el.className = `ui-toast ${type} enter`;
    const ICON = { success:'check_circle', info:'info', warn:'warning', error:'error' }[type] || 'notifications';
    el.innerHTML = `
      <div class="t-icon"><span class="material-symbols-rounded">${ICON}</span></div>
      <div class="t-body">${title ? `<div class="t-title">${title}</div>` : ''}<div class="t-msg">${message || ''}</div></div>
      <div class="t-cta">${actionText ? `<button class="t-action">${actionText}</button>` : ''}<button class="t-close" title="Cerrar"><span class="material-symbols-rounded">close</span></button></div>
      <div class="t-bar"><i></i></div>`;
    const host = document.getElementById('toastHost'); host.appendChild(el);
    const bar = el.querySelector('.t-bar > i'); bar.style.background = getComputedStyle(el.querySelector('.t-action') || el.querySelector('.t-icon')).backgroundColor; bar.style.transform = 'scaleX(1)';
    let tStart = performance.now(), raf;
    function tick(now){ const p=Math.min(1,(now-tStart)/duration); bar.style.transform=`scaleX(${1-p})`; raf = p<1 ? requestAnimationFrame(tick) : close(); }
    requestAnimationFrame(()=> requestAnimationFrame(()=> tick(performance.now())));
    function close(){ cancelAnimationFrame(raf); el.classList.remove('enter'); el.classList.add('exit'); setTimeout(()=>{ el.remove(); showing--; flush(); }, 220); }
    el.querySelector('.t-close').addEventListener('click', close);
    const actionBtn = el.querySelector('.t-action'); if(actionBtn && typeof onAction==='function'){ actionBtn.addEventListener('click', ()=>{ try{ onAction(); }finally{ close(); }}); }
    el.addEventListener('mouseenter', ()=> cancelAnimationFrame(raf));
    el.addEventListener('mouseleave', ()=>{ const remain=parseFloat(bar.style.transform.replace('scaleX(','').replace(')',''))||1; tStart=performance.now()-(duration*(1-remain)); tick(performance.now()); });
  }
  function createToast(opts){ const cfg=typeof opts==='string'?{message:opts}:{...opts}; cfg.type=(cfg.type||'info').toLowerCase(); queue.push(cfg); flush(); }
  window.toast = window.toast || createToast;
})();
</script>

</body>
</html>
